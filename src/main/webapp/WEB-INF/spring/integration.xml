<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<beans:beans xmlns:beans="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.springframework.org/schema/integration"
	xmlns:mail="http://www.springframework.org/schema/integration/mail"
	xmlns:jdbc="http://www.springframework.org/schema/integration/jdbc"
	xsi:schemaLocation="
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration-2.2.xsd
		http://www.springframework.org/schema/integration/mail http://www.springframework.org/schema/integration/mail/spring-integration-mail-2.2.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.2.xsd
		http://www.springframework.org/schema/integration/jdbc http://www.springframework.org/schema/integration/jdbc/spring-integration-jdbc-2.2.xsd">

	<!-- Shop event recording -->
	<gateway id="shopEventGateway" service-interface="com.yubi.core.statistics.EventGateway"
		default-request-channel="shopEventChannel" />

	<channel id="shopEventChannel">
		<queue message-store="mailMessageStore" />
	</channel>

	<service-activator id="shopEventService"
		input-channel="shopEventChannel" ref="shopEventAccess" auto-startup="true">
		<poller receive-timeout="1" fixed-delay="20" time-unit="SECONDS" />
	</service-activator>

	<!-- Mail sending -->
	<gateway id="mailGateway" service-interface="com.yubi.core.mail.MailGateway"
		default-request-channel="mailTransformationChannel" />

	<channel id="mailTransformationChannel">
		<queue message-store="mailMessageStore" />
	</channel>

	<jdbc:message-store id="mailMessageStore"
		data-source="dataSource"  />

	<transformer input-channel="mailTransformationChannel"
		output-channel="mailSendingChannel" ref="mailTransformer" method="transform"/>
	
	<poller default="true" fixed-rate="20" time-unit="SECONDS" />

	<channel id="mailSendingChannel" />

	<mail:outbound-channel-adapter id="outboundMailChannelAdaptor"
		channel="mailSendingChannel" mail-sender="mailSender">
	</mail:outbound-channel-adapter>
</beans:beans>
